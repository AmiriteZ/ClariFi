# ClariFi Machine Learning & AI System Architecture

## Overview

The ClariFi "Machine Learning" system is a hybrid architecture that combines deterministic statistical analysis with Generative AI (LLM). Instead of a single black-box model, it uses a pipeline of heuristic algorithms to extract structured financial insights, which are then synthesized by OpenAI's GPT models to provide natural, context-aware financial advice.

## System Architecture

### 1. The Intelligence Pipeline

The system follows a three-stage pipeline to process user data:

1.  **Data Ingestion & Cleaning**: Raw transaction data is normalized.
2.  **Heuristic Analysis (The "ML" Core)**: Statistical algorithms process transactions to identify patterns, recurring items, and forecast cash flow.
3.  **Generative Synthesis (The "AI" Layer)**: Structured insights are formatted into a context payload and sent to the LLM (OpenAI) to generate conversational responses.

## Core Components (`server/src/ml`)

### A. Pattern Analyzer (`analyzer.ts`)

This module is responsible for feature extraction from raw transaction data.

- **Recurring Transaction Detection**:
  - **Algorithm**: Groups transactions by merchant/description.
  - **Logic**: Identifies potential bills or subscriptions if:
    - Amount variance is low (< 10%).
    - Time intervals align with weekly (7 days), monthly (30 days), or yearly (365 days) patterns.
    - Minimum of 3 occurrences (or strict intervals).
  - **Classification**: Distinguishes between "Income", "Bills" (Utilities, Rent), and "Subscriptions" (Streaming, Gym) based on keywords and direction of flow.

- **Spending Pattern Analysis**:
  - **Aggregates**: Calculates average monthly spend per category.
  - **Trend Detection**: Compares "Last Month" vs. "Average" to flag spending as **Increasing** (>110%), **Decreasing** (<90%), or **Stable**.
  - **Volatility**: Measures how much spending fluctuates in a category (currently a placeholder implementation).

- **Cash Flow Engine**:
  - Calculates `Savings Rate`, `Average Monthly Income`, and `Average Monthly Expenses` based on a rolling window (default: 3 months).

### B. Financial Forecaster (`forecaster.ts`)

A deterministic simulation engine for short-term balance projection.

- **Logic**: Projects the user's account balance 30 days into the future.
- **Method**:
  - Starts with `Current Balance`.
  - Daily iteration:
    - Subtracts `Average Daily Variable Spend`.
    - Adds/Subtracts known `Recurring Transactions` on their specific due dates.

### C. Insight Generator (`insights.ts`)

A rule-based engine that converts raw stats into actionable advice objects.

- **Budget Watchdog**: Flags budgets approaching limits (>85% utilization) or exceeded (>100%).
- **Goal Tracker**: Calculates required monthly savings to hit target dates and celebrates milestones.
- **Conversation Starter**: Prioritizes insights to feed the Chatbot:
  1.  **Critical**: Budget overruns or unusual spending.
  2.  **Praise**: Goals reached or spending reductions.
  3.  **Advice**: General check-ins if everything is stable.

## AI Assistant Integration (`server/src/ai`)

### A. The "ClariFi Assistant" Persona

Implemented via System Prompts (`prompts.ts`), the AI is configured to be:

- **Role**: Empathetic, non-judgmental financial advisor.
- **Constraint**: Strictly limited to financial topics (Domain Restriction).
- **Personality**: Warm, concise, and proactive.

### B. Context Injection (`context.ts`)

To minimize hallucinations and ensure accuracy, the system does **not** rely on the LLM to do math. Instead, it injects the pre-calculated stats from the ML layer into the prompt.

**Prompt Structure:**

1.  **System Instructions**: Definitions of tone and boundaries.
2.  **Financial Context Block** (Generated by `ML` layer):
    - "User has Stable Income"
    - "Savings Rate: 15%"
    - "Spending on Dining Out is Increasing ðŸ“ˆ"
    - "Upcoming Bill: Netflix (â‚¬15) in 3 days"
3.  **Conversation History**: Last `N` messages for continuity.

## Summary

In essence, **ClariFi's "ML" is the math, and the "AI" is the interface.** The hard analysis (forecasting, pattern recognition) is done simply and deterministically to ensure accuracy, while the LLM is used effectively for its strength: natural language understanding and empathetic communication.
